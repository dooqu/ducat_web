<%@ Page Title="" Language="C#" MasterPageFile="~/Main.Master" AutoEventWireup="true" CodeBehind="AreaManager.aspx.cs" Inherits="admin.Areas" %>

<asp:Content ID="Content" ContentPlaceHolderID="ContentPlaceHolder" runat="server">
    <style>
        #tbl, .tbl {
            border: 0px solid blue;
            table-layout: fixed;
        }

            .tbl tr {
            }

                .tbl tr td, .tbl tr .td_checked {
                    padding: 0px 2px;
                    height: 25px;
                    text-align: center;
                    font-size: 12px;
                    margin: 0px;
                    background-color: #efefef;
                    border: 1px solid #c0c0c0;
                }

                .tbl tr .td_checked {
                    background-color: #9c9ace;
                    font-size: 18px;
                    color: white;
                }

            .tbl .firstRow td {
                background-color: #cecfff;
                height: 35px;
            }

            .tbl tr td textarea {
                background-color: #efefef;
                border: 1px solid #9c9ace;
                width: 80px;
                overflow-y: auto;
                height: 50px;
                margin: 0px;
            }
    </style>
    <div class="row" style="height: 30px">
        <div class="col-sm-12">
            <div class="page-header" style="border: 0px solid red; line-height: 30px; height: 30px; padding-bottom: 0px">
                <h2>矩阵数据管理</h2>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-12">
            <div id="msg" style="display:none"></div>
            <div class="row">
                <div class="col-md-3">
                    <select id="optAreas" onchange="loadOptions(this.options[this.selectedIndex].value)" class="form-control">
                        <asp:Repeater ID="areaReader" runat="server">
                            <ItemTemplate>
                                <option value="<%# DataBinder.Eval(Container.DataItem, "AreaId") %>"><%# DataBinder.Eval(Container.DataItem, "AreaName") %></option>
                            </ItemTemplate>
                        </asp:Repeater>
                    </select>
                </div>
                <div class="col-md-3">
                    <input class="form-control" type="button" value="保存该州的矩阵数据" onclick="save_config()" /></div>
                <div class="col-md-6"></div>

            </div>
            <table class="tbl" id="tblOptions" onclick="tbl_click(this)">
                <tr class="firstRow">
                    <td colspan="10">身份选项设置</td>
                    <td colspan="10">公司用途选项设置</td>
                    <td colspan="3">SSI选项设置</td>
                    <td colspan="3">投资人选项设置</td>
                    <td colspan="3">公司类型选项设置</td>
                    <td>类型</td>
                    <td colspan="6">费用和耗时</td>
                </tr>
                <tr style="height: 100px">
                    <td><textarea id="t0"></textarea></td>
                    <td><textarea id="t1"></textarea></td>
                    <td><textarea id="t2"></textarea></td>
                    <td><textarea id="t3"></textarea></td>
                    <td><textarea id="t4"></textarea></td>
                    <td><textarea id="t5"></textarea></td>
                    <td><textarea id="t6"></textarea></td>
                    <td><textarea id="t7"></textarea></td>
                    <td><textarea id="t8"></textarea></td>
                    <td><textarea id="t9"></textarea></td>


                    <!-- -->
                    <td><textarea id="t10"></textarea></td>
                    <td><textarea id="t11"></textarea></td>
                    <td><textarea id="t12"></textarea></td>
                    <td><textarea id="t13"></textarea></td>
                    <td><textarea id="t14"></textarea></td>
                    <td><textarea id="t15"></textarea></td>
                    <td><textarea id="t16"></textarea></td>
                    <td><textarea id="t17"></textarea></td>
                    <td><textarea id="t18"></textarea></td>
                    <td><textarea id="t19"></textarea></td>


                    <!-- -->
                    <td><textarea id="t20"></textarea></td>
                    <td><textarea id="t21"></textarea></td>
                    <td><textarea id="t22"></textarea></td>

                    <!-- -->
                    <td><textarea id="t23"></textarea></td>
                    <td><textarea id="t24"></textarea></td>
                    <td><textarea id="t25"></textarea></td>

                    <!-- -->
                    <td><textarea id="t26"></textarea></td>
                    <td><textarea id="t27"></textarea></td>
                    <td><textarea id="t28"></textarea></td>
                    <td><textarea>公司类型</textarea></td>
                    <td><textarea>基础费用</textarea></td>
                    <td><textarea>政府费用</textarea></td>
                    <td><textarea>加急费用</textarea></td>
                    <td><textarea>工作日耗时</textarea></td>
                    <td><textarea>加急耗时</textarea></td>
                    <td><textarea>费用备注</textarea></td>
                </tr>
                </tr>

                <!-- </table> -->
                <!-- <table id="tbl" cellspacing="0" cellpadding="0" background-color="#efef00" border="1" class="tbl" onclick="c()"> -->
                <tr height="20">
                    <td id="m0"></td>
                    <td id="m1"></td>
                    <td id="m2"></td>
                    <td id="m3"></td>
                    <td id="m4"></td>
                    <td id="m5"></td>
                    <td id="m6"></td>
                    <td id="m7"></td>
                    <td id="m8"></td>
                    <td id="m9"></td>
                    <td id="m10"></td>
                    <td id="m11"></td>
                    <td id="m12"></td>
                    <td id="m13"></td>
                    <td id="m14"></td>
                    <td id="m15"></td>
                    <td id="m16"></td>
                    <td id="m17"></td>
                    <td id="m18"></td>
                    <td id="m19"></td>
                    <td id="m20"></td>
                    <td id="m21"></td>
                    <td id="m22"></td>
                    <td id="m23"></td>
                    <td id="m24"></td>
                    <td id="m25"></td>
                    <td id="m26"></td>
                    <td id="m27"></td>
                    <td id="m28"></td>
                    <td><textarea readonly>FNC</textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr height="20">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><textarea>DNC</textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr height="20">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><textarea>FSCC</textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr height="20">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><textarea>DSCC</textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr height="20">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><textarea>FSSC</textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr height="20">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><textarea>SSC</textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr height="20">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><textarea>LLC</textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
                <tr height="20">
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <td><textarea>DLLC</textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                    <td><textarea></textarea></td>
                </tr>
            </table>

<%--            <div class="jumbotron" style="overflow: hidden; padding: 10px;">


                <select class="form-control" onchange="q1_change()">
                    <option>请选择</option>
                    <option>中国公民</option>
                    <option>绿卡、美公、E,K</option>
                    <option>H,L,O,P,Q,G,N,R,S,T</option>
                    <option>F.F.J.B.C.D.I</option>
                    <option>其他</option>
                </select>

                <select class="form-control" id="q2" onchange="q2_change()">
                    <option>请选择</option>
                </select>

                <select class="form-control" id="q3" onchange="q3_change()">
                    <option>请选择</option>
                </select>

                <select class="form-control" id="q4" onchange="q4_change()">
                    <option>请选择</option>
                </select>

                <select class="form-control" id="q5" onchange="q5_change()">
                    <option>请选择</option>
                </select>

                <select class="form-control" id="q6">
                    <option>请选择</option>
                </select>
            </div>--%>
        </div>
    </div>
    <script>
        var CELL_LENGTH = 29;
        var METRIX_LENGTH = CELL_LENGTH * 8;
        var metrix = new Array(METRIX_LENGTH);
        //INIT_METRIX
        for (var i = 0; i < metrix.length; i++)
            metrix[i] = 0;
			
        var e = function(s)
        {
            return document.getElementById(s);
        }
        function init_cell()
        {
            var tbl = e("tblOptions");
            var rows = tbl.rows;

            for (var i = 2; i < rows.length; i++)
            {
                var cells = rows[i].cells;
                for (var j = 0; j < cells.length && j < 29; j++)
                {
                    metrix[(i - 2) * CELL_LENGTH + j] = ((tbl.rows[i].cells[j].className == "") ? 0 : 1);
                }
            }
            e("msg").innerHTML = metrix.join(",");
        }

        function tbl_click(e)
        {
            var cell = event.target;
            if (cell.nodeName != "TD")
                return;            

            if((cell.firstChild != null && cell.firstChild.nodeName == "TEXTAREA") || cell.parentNode.className == "firstRow")
                return;

            cell.className = (cell.className == "")? "td_checked" : "";
            cell.innerText = (cell.innerText == "")? "✓" : "";
            init_cell();
        }

		    
        var q2_rows = [];
        var q3_rows = [];
        var q4_rows = [];
        var q5_rows = [];
        var q6_rows = [];

		
        function clearOption()
        {
            for(var i = 0; i < arguments.length; i++)
            {
                var opt = e(arguments[i]);
                if(opt == null)
                    continue;
                while(opt.options.length > 1)
                {
                    opt.options.remove(opt.options.length - 1);
                }
            }
        }
		
        function getMetrixValue(rowIndex, cellIndex)
        {
            return metrix[rowIndex * CELL_LENGTH + cellIndex];
        }

        function getAvaiableRowBySelectedOption(selectedOptionIdx, availableRowsArr)
        {
            var availableRows = [];
            for (var i = 0; i < availableRowsArr.length; i++)
            {
                if(getMetrixValue(availableRowsArr[i], selectedOptionIdx))
                {
                    availableRows.push(availableRowsArr[i]);
                }
            }
            return availableRows;
        }

        function getAvailableOptionsBySelectedRows(cellIdxStart, cellIdxEnd, availableRowArr)
        {
            var options = [];
            for(var currCell = cellIdxStart; currCell < cellIdxEnd; currCell++)
            {
                for(var j = 0; j < availableRowArr.length; j++)
                {
                    if(getMetrixValue(availableRowArr[j], currCell))
                    {
                        options.push(currCell);
                        break;
                    }
                }
            }
            return options;
        }
		
        function getCellIndexFromOptionText(cellName, startIndex = 0)
            {
                var tbl = e("tblOptions");	
                var i = startIndex;
                for(; i < tbl.rows[0].cells.length; i++)
                {
                    if(tbl.rows[0].cells[i].firstChild.value == cellName)
                        return i;
                }			
                return -1;
            }
	
            function q1_change()
            {
                var q1 = event.target;
                var selectedIndex = q1.selectedIndex - 1;
                var q2 = document.getElementById("q2");
                if (selectedIndex < 0)
                    return;
				
                clearOption("q2", "q3", "q4", "a5");

                while (q2.options.length > 1)
                {
                    q2.options.remove(q2.options.length - 1);
                }
			
                availableRowsGlobal = [0, 1, 2, 3, 4, 5, 6, 7];			
                //更新q2_rows通路
                q2_rows = getAvaiableRowBySelectedOption(selectedIndex, availableRowsGlobal);			
                if (q2_rows.length)
                {
                    var optNameTbl = e("tblOptions");				
                    //在更新的通路的限制下， 在x,y区间的可用options;
                    var q2_options_idxs = getAvailableOptionsBySelectedRows(10, 20, q2_rows);
                    for(var i = 0; i < q2_options_idxs.length; i++)
                    {
                        var option_new = new Option();
                        option_new.text = optNameTbl.rows[0].cells[q2_options_idxs[i]].firstChild.value;
                        e("q2").options.add(option_new);				
                    }				
                    q2.selectedIndex = 0;
                }            
            }
		
            function q2_change()
            {
                var q2 = event.target;
                var q3 = e("q3");
			
                if(q2.selectedIndex == 0)
                    return;
				
                var selectedIndex = getCellIndexFromOptionText(q2.options[q2.selectedIndex].text);		
                if(selectedIndex == -1)
                    return;
				
                clearOption("q3", "q4", "q5");
			
			
                //更新q3_rows通路
                q3_rows = getAvaiableRowBySelectedOption(selectedIndex, q2_rows);
                e("msg").innerHTML = "q3_rows=" + q3_rows.join(",");
			
			
                if(q3_rows.length)
                {
                    var optNameTbl = e("tblOptions");
                    var q3_options_idxs = getAvailableOptionsBySelectedRows(20, 23, q3_rows);				 
                    for(var i = 0; i < q3_options_idxs.length; i++)
                    {
                        var option_new = new Option();
                        option_new.text = optNameTbl.rows[0].cells[q3_options_idxs[i]].firstChild.value;
                        q3.options.add(option_new);				
                    }				
                }
            }
		
            function q3_change()
            {
                var q3 = event.target;
                var q4 = e("q4");
			
                if(q3.selectedIndex == -1)
                    return;
				
                var selectedIndex = getCellIndexFromOptionText(q3.options[q3.selectedIndex].text);		
                if(selectedIndex == -1)
                    return;
				
                clearOption("q4", "q5");
			
                //更新q3_rows通路
                q4_rows = getAvaiableRowBySelectedOption(selectedIndex, q3_rows);
			
                e("msg").innerHTML = "q4_rows=" + q4_rows.join(",");
			
                if(q4_rows.length)
                {
                    var optNameTbl = e("tblOptions");
                    var q4_options_idxs = getAvailableOptionsBySelectedRows(23, 26, q4_rows);				 
                    for(var i = 0; i < q4_options_idxs.length; i++)
                    {
                        var option_new = new Option();
                        option_new.text = optNameTbl.rows[0].cells[q4_options_idxs[i]].firstChild.value;
                        q4.options.add(option_new);				
                    }				
                }
            }
		
            function q4_change()
            {
                var q4 = event.target;
                var q5 = e("q5");
			
                if(q4.selectedIndex == -1)
                    return;
				
                var selectedIndex = getCellIndexFromOptionText(q4.options[q4.selectedIndex].text, 23);		
                if(selectedIndex == -1)
                    return;
				
                clearOption("q5");

                //更新q3_rows通路
                q5_rows = getAvaiableRowBySelectedOption(selectedIndex, q4_rows);
			
                e("msg").innerHTML = "q5_rows=" + q5_rows.join(",");
			
                if(q5_rows.length)
                {
                    var optNameTbl = e("tblOptions");
                    var q5_options_idxs = getAvailableOptionsBySelectedRows(26, 29, q5_rows);				 
                    for(var i = 0; i < q5_options_idxs.length; i++)
                    {
                        var option_new = new Option();
                        option_new.text = optNameTbl.rows[0].cells[q5_options_idxs[i]].firstChild.value;
                        q5.options.add(option_new);				
                    }				
                }
            }

            function q5_change()
            {
                var q5 = event.target;
                var q6 = e("q6");
			
                if(q4.selectedIndex == -1)
                    return;
				
                var selectedIndex = getCellIndexFromOptionText(q5.options[q5.selectedIndex].text, 26);		
                if(selectedIndex == -1)
                    return;
				
                clearOption("q6");			
                //更新q3_rows通路
                q6_rows = getAvaiableRowBySelectedOption(selectedIndex, q5_rows);
			
                if(q6_rows.length)
                {
                    var optNameTbl = e("tblOptions");							 
                    for(var i = 0; i < q6_rows.length; i++)
                    {
                        var option_new = new Option();
                        option_new.text = optNameTbl.rows[q6_rows[i]].cells[29].firstChild.value;
                        q6.options.add(option_new);				
                    }				
                }
            }
		
            function save_config()
            {
                var titles = [];
                var prices = [];
                var comments = [];
                var tbl = e("tblOptions");
                var cells = tbl.rows[1].cells;
                for(var i = 0; i < cells.length && i < CELL_LENGTH; i++)
                {
                    titles.push(encodeURIComponent(tbl.rows[1].cells[i].firstChild.value));
                }

                for(var i = 2; i < 10; i++)
                {
                    for(var j = 30; j <= 34; j++)
                    {
                        prices.push((tbl.rows[i].cells[j].firstChild.value));
                    }				
                } 
                
                for(var i = 2; i < 10; i++)
                {
                    comments.push(encodeURIComponent(tbl.rows[i].cells[35].firstChild.value));
                }

                var optAreas = document.getElementById("optAreas");
                var areaid = optAreas.options[optAreas.selectedIndex].value;
                $.post("/api/UpdateOptions.ashx?areaid=" + areaid, {titles : titles.join(","), metrix : metrix.join(","), prices : prices.join(","), comments : comments.join(",")}, function(data, status)
                {
                    alert(data);
                });
            }
        
            function loadOptions(areaid)
            {
                $.get("/api/LoadOptions.ashx?areaid=" + areaid, function(data, status){
                    if(status == "success" && data.IsError == false)
                    {
                        var tbl = e("tblOptions");
                        var title_len = (data.Titles.length);

                        for(var i = 0; i < title_len; i++)
                        {
                            tbl.rows[1].cells[i].firstChild.value = decodeURIComponent(data.Titles[i]);
                        }

                        for(var i = 0; i < data.Metrix.length; i++)
                        {
                            var rowIndex = parseInt(i / CELL_LENGTH);
                            var cellIndex = (i % CELL_LENGTH);                        
                            var c = null;
		                
                            try
                            {
                                c = tbl.rows[rowIndex + 2].cells[cellIndex];
                            }
                            catch(e)
                            {
                                break;
                            }

                            c.className = (data.Metrix[i] == "1")? "td_checked" : "";
                            c.innerText = (data.Metrix[i] == "1")? "✓" : "";

                            metrix[i] = parseInt(data.Metrix[i]);
                        }


                        for(var i = 0; i < data.Prices.length; i++)
                        {
                            var rowIndex = parseInt(i / 5);
                            var cellIndex = 30 + (i % 5);
                            try
                            {
                                tbl.rows[rowIndex + 2].cells[cellIndex].firstChild.value = data.Prices[i];
                            }
                            catch(e)
                            {
                                break;
                            }
                        }

                        for(var i = 0; i < data.Comments.length; i++)
                        {
                            try
                            {
                                tbl.rows[i + 2].cells[35].firstChild.value = decodeURIComponent(data.Comments[i]);
                            }
                            catch(e)
                            {
                                break;
                            }
                        }
                    }
                }, "json");
            }

            loadOptions(0);

    </script>
</asp:Content>
